@model fitnessCenter.web.Models.Appointment

@{
    ViewData["Title"] = "Randevu Oluştur";
}

<h2>Randevu Oluştur</h2>
<hr />

<form asp-action="Create" method="post">
    <div asp-validation-summary="All" class="text-danger"></div>

    @if (User.IsInRole("Admin"))
    {
        <div class="mb-3">
            <label asp-for="MemberId" class="form-label"></label>
            <select asp-for="MemberId" class="form-select" asp-items="ViewBag.MemberList">
                <option value="">-- Üye Seçin --</option>
            </select>
            <span asp-validation-for="MemberId" class="text-danger"></span>
        </div>
    }
    else
    {
        <div class="mb-3">
            <label class="form-label">Üye</label>
            <input class="form-control" value="@ViewBag.CurrentMemberName" disabled />
        </div>
        <input type="hidden" asp-for="MemberId" value="@ViewBag.CurrentMemberId" />
    }

    <div class="mb-3">
        <label asp-for="ServiceId" class="form-label"></label>
        <select asp-for="ServiceId" class="form-select" asp-items="ViewBag.ServiceId" id="serviceSelect">
            <option value="">-- Hizmet Seçin --</option>
        </select>
        <span asp-validation-for="ServiceId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label asp-for="TrainerId" class="form-label"></label>
        <select asp-for="TrainerId" class="form-select" asp-items="ViewBag.TrainerId" id="trainerSelect">
            <option value="">-- Eğitmen Seçin --</option>
        </select>
        <span asp-validation-for="TrainerId" class="text-danger"></span>
    </div>

    <div class="mb-3">
        <label class="form-label">Tarih</label>
        <input id="dateInput" class="form-control" type="date" />
    </div>

    <div class="mb-3">
        <label class="form-label">Müsait Saatler</label>
        <select id="slotSelect" class="form-select">
            <option value="">Önce hizmet, eğitmen ve tarih seçiniz</option>
        </select>
    </div>

    <input type="hidden" asp-for="StartTime" id="StartTime" />
    <input type="hidden" asp-for="EndTime" id="EndTime" />

    <button type="submit" class="btn btn-primary">Randevu Oluştur</button>
</form>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

    <script>
        (function () {
            const serviceSelect = document.getElementById("serviceSelect");
            const trainerSelect = document.getElementById("trainerSelect");
            const dateInput = document.getElementById("dateInput");
            const slotSelect = document.getElementById("slotSelect");

            const startHidden = document.getElementById("StartTime");
            const endHidden = document.getElementById("EndTime");

            const baseUrl = '@Url.Action("GetAvailableSlots", "Appointments", new { area = "" })';

            function setSlotMessage(msg) {
                slotSelect.innerHTML = "";
                const o = document.createElement("option");
                o.value = "";
                o.textContent = msg;
                slotSelect.appendChild(o);
            }

            async function loadSlots() {
                setSlotMessage("Saatler yükleniyor...");
                startHidden.value = "";
                endHidden.value = "";

                const trainerId = Number(trainerSelect.value);
                const serviceId = Number(serviceSelect.value);
                const dateVal = dateInput.value;

                if (!trainerId || !serviceId || !dateVal) {
                    setSlotMessage("Önce hizmet, eğitmen ve tarih seçiniz");
                    return;
                }

                const url = `${baseUrl}?trainerId=${trainerId}&serviceId=${serviceId}&date=${encodeURIComponent(dateVal)}`;

                try {
                    const response = await fetch(url, { headers: { "Accept": "application/json" } });
                    if (!response.ok) throw new Error("HTTP " + response.status);

                    const slots = await response.json();

                    if (!Array.isArray(slots) || slots.length === 0) {
                        setSlotMessage("Bu gün için müsait saat yok");
                        return;
                    }

                    slotSelect.innerHTML = "";
                    const def = document.createElement("option");
                    def.value = "";
                    def.textContent = "Saat seçiniz";
                    slotSelect.appendChild(def);

                    slots.forEach(s => {
                        const opt = document.createElement("option");
                        opt.value = s;
                        opt.textContent = s;
                        slotSelect.appendChild(opt);
                    });
                } catch (err) {
                    console.error(err);
                    setSlotMessage("Saatler yüklenirken hata oluştu");
                }
            }

            slotSelect.addEventListener("change", () => {
                const val = slotSelect.value;
                const dateVal = dateInput.value;

                if (!val || !dateVal) {
                    startHidden.value = "";
                    endHidden.value = "";
                    return;
                }

                const parts = val.split("-");
                if (parts.length !== 2) {
                    startHidden.value = "";
                    endHidden.value = "";
                    return;
                }

                startHidden.value = `${dateVal}T${parts[0]}:00`;
                endHidden.value   = `${dateVal}T${parts[1]}:00`;
            });

            serviceSelect.addEventListener("change", loadSlots);
            trainerSelect.addEventListener("change", loadSlots);
            dateInput.addEventListener("change", loadSlots);
        })();
    </script>
}
